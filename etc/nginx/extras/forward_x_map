# Define default protocols' ports
map $scheme $def_port {
    "http" ":80";
    "https" ":443";
    default "";
}

# Remap X-Forwarded headers for proxy chaining.
geo $realip_remote_addr $x_trusted {
    127.0.0.0/8 1;
    default 0;
}

map $x_trusted $x_scheme {
    1 $http_x_forwarded_proto;
    default $scheme;
}
map $x_trusted $x_host {
    1 $http_x_forwarded_host;
    default $host:$server_port;
}
map $x_trusted $x_port {
    1 $http_x_forwarded_port;
    default $server_port;
}
